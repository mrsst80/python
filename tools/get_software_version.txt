#!/opt/freeware/bin/python3.9
# 
import subprocess
import shlex
import re
import argparse

ssh_key = "id_rsa_hmc"
ssh_user = "stefan"

def get_servers_list():
   mac_groups = []
   servers = {}
   cmd_get_mac_groups = "lsnim -t mac_group"
   cmd_get_mac_groups = shlex.split(cmd_get_mac_groups)
   mac_group_pattern = r"(.*Group)" 
   #mac_group_pattern = r"(Power8-S824-Ire-Group)" 
   server_pattern = r"(member.*)= (.*)"
  
   mac_groups_tmp = subprocess.run(cmd_get_mac_groups, text=True,capture_output=True) 
   for line in mac_groups_tmp.stdout.split("\n"):
     match = re.search(mac_group_pattern, line)
     if match:
       mac_groups.append(match.group(0))

   for mac_group in mac_groups:
     cmd_get_servers = "lsnim -l {}".format(mac_group)
     cmd_get_servers = shlex.split(cmd_get_servers)
     servers_list = subprocess.run(cmd_get_servers,text=True,capture_output=True)

     for line in servers_list.stdout.split("\n"):
       match = re.search(server_pattern, line)
       if match:
         servers[match.group(2)] = "1"

   return servers

def get_software_version(servers,software_name):
   for server in servers.keys():
     cmd_get_software_version = "rpm -q {}".format(software_name)
     ssh_connect_string = "ssh -T -oStrictHostKeyChecking=no -oConnectTimeout=10 -oBatchMode=yes -i {} {}@{}".format(ssh_key,ssh_user,server)
     ssh_connect_string = shlex.split(ssh_connect_string)

     proceses = [subprocess.Popen(ssh_connect_string) ]

     with subprocess.Popen(ssh_connect_string,
                        stdin=subprocess.PIPE, stdout=subprocess.PIPE,text=True) as ssh:

       out, err = ssh.communicate(cmd_get_software_version)
       print(out)

def run_ssh_parallel(servers,software_name,package_type):
   if package_type == "bff":
     cmd_get_software_version = "lslpp -qLc {}".format(software_name)
   elif package_type == "rpm":
     cmd_get_software_version = "rpm -q {}".format(software_name)
   else:
     return "Uknown package type" 

   cmd_list = []
   versions = {}
   
   for server in servers:
     cmd = "ssh -T -q -oStrictHostKeyChecking=no -oConnectTimeout=10 -oBatchMode=yes -i {} -l {} {} \"{}\"".format(ssh_key,ssh_user,server,cmd_get_software_version)
     cmd_list.append(cmd)

   procs_list = [subprocess.Popen(shlex.split(cmd), stdout=subprocess.PIPE, stderr=subprocess.PIPE) for cmd in cmd_list]
   for proc in procs_list:
     proc.wait()
     if proc.returncode == 0:
        if package_type == "bff":
          ver = proc.stdout.readlines()[0].strip().decode('UTF-8').split(':')[2]
        elif package_type == "rpm":
          ver = proc.stdout.readlines()[0].strip().decode('UTF-8')
        versions[proc.args[10]] = ver
     else:
        err = proc.stderr.readlines()[0].strip().decode('UTF-8')
        versions[proc.args[10]] = err
 
   return versions

def main():
  parser = argparse.ArgumentParser(description='Report software version of installed software on AIX')
  group = parser.add_mutually_exclusive_group(required=True)
  group.add_argument('-b', dest='bff', action='store_const', const='bff',help='query version of bff package')
  group.add_argument('-r', dest='rpm', action='store_const', const='rpm',help='query version of rpm package')
  parser.add_argument('package_name', nargs=1, help='Name of the package')
  args = parser.parse_args()
 
  if args.rpm:
    package_type = "rpm"
  elif args.bff:
    package_type = "bff"
  software_name = args.package_name[0]
  
  servers = get_servers_list()
  
  versions = run_ssh_parallel(servers,software_name,package_type)
  
  for key in versions.keys():
    print("{},{}".format(key,versions[key]))
  
if __name__ == "__main__":
   main()

